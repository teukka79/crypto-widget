<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crypto Glass v54 - Masterpiece Edition</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --midnight-blue: hsla(220, 100%, 10%, 0.85);
            --forest-green: hsla(150, 80%, 15%, 0.7);
            --static-green-text: #4ade80;
            --static-red-text: #f87171;
            --glass-border: rgba(255, 255, 255, 0.06); 
        }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { height: 100%; margin: 0; padding: 0; background-color: #010409; overflow: hidden; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex; flex-direction: column; align-items: center; color: #e6edf3;
            background-color: #010409;
        }

        .widget {
            position: relative; width: 100%; max-width: 390px; height: 100vh;
            margin: 0 auto; padding: 15px; padding-top: calc(env(safe-area-inset-top) + 20px);
            background: radial-gradient(circle at center, var(--forest-green) 0%, var(--midnight-blue) 100%);
            backdrop-filter: blur(40px);
            display: flex; flex-direction: column; overflow-x: hidden;
            border-left: 1px solid var(--glass-border); border-right: 1px solid var(--glass-border);
        }

        #modalOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(15px); display:none; align-items:center; justify-content:center; z-index:11000; }
        #modalContainer { background:#0d1117; padding:25px; border-radius:24px; width:320px; text-align:center; border:1px solid var(--glass-border); }

        #floatingAlert {
            position: fixed; top: -180px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 30px); max-width: 380px; z-index: 12000;
            border-radius: 24px; padding: 18px; display: flex; align-items: center; gap: 15px;
            transition: top 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(40px) saturate(180%);
            cursor: pointer; overflow: hidden;
        }
        #floatingAlert.show { top: 20px; }
        #faIconContainer { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); flex-shrink: 0; }
        #faContent { flex: 1; overflow: hidden; display: flex; flex-direction: column; gap: 2px; }
        .reveal-box { overflow: hidden; position: relative; width: 100%; }
        #faTitle { font-weight: 900; font-size: 16px; color: #fff; text-transform: uppercase; transform: translateX(-110%); transition: transform 0.7s cubic-bezier(0.19, 1, 0.22, 1); transition-delay: 0.4s; }
        #faSubtitle { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.7); transform: translateX(-110%); transition: transform 0.7s cubic-bezier(0.19, 1, 0.22, 1); transition-delay: 0.55s; }
        #floatingAlert.show #faTitle, #floatingAlert.show #faSubtitle { transform: translateX(0); }

        .header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .crypto-icon { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; }
        .crypto-icon img { width: 100%; height: 100%; object-fit: contain; }
        #cryptoName { font-weight: 900; font-size: 22px; }
        #cryptoPair { font-size: 12px; opacity: 0.6; font-weight: 600; }

        .select-row { display: flex; gap: 8px; margin-bottom: 15px; }
        select { flex: 1; height: 48px; background: rgba(0, 0, 0, 0.4); border: 1px solid var(--glass-border); border-radius: 12px; color: #fff; font-size: 15px; font-weight: 800; appearance: none; padding: 0 12px; }

        .tf-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .tf-btn { height: 48px; border: none; border-radius: 12px; font-weight: 800; background: rgba(255, 255, 255, 0.05); color: rgba(255, 255, 255, 0.4); font-size: 16px; }
        .tf-btn.active { background: rgba(34, 197, 94, 0.4); color: #fff; }

        .price-display { text-align: center; margin-bottom: 15px; }
        .price { font-size: 38px; font-weight: 800; letter-spacing: -1px; }
        #priceChangeContainer { display:inline-flex; align-items:center; gap:4px; font-size:14px; font-weight:800; padding:6px 12px; border-radius:10px; margin-top:8px; }

        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat { background: rgba(0, 0, 0, 0.4); padding: 10px; border-radius: 14px; border: 1px solid var(--glass-border); }
        .stat div:first-child { color:rgba(255,255,255,0.5); font-size:10px; font-weight:700; text-transform: uppercase; }
        .stat div:last-child { font-size:13px; font-weight:800; margin-top:4px; }

        .alarm-section { background: rgba(0, 0, 0, 0.4); border-radius: 20px; padding: 15px; border: 1px solid var(--glass-border); margin-bottom: 15px; }
        .alarm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .alarm-grid input { height: 52px; border-radius: 12px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); color: #fff; text-align: center; font-weight: 800; width: 100%; font-size: 16px; }

        .btn-static { height: 48px; border: none; border-radius: 12px; font-weight: 800; width: 100%; font-size: 16px; text-transform: uppercase; }
        .static-green { background: rgba(34, 197, 94, 0.15); color: var(--static-green-text); }
        .static-red { background: rgba(239, 68, 68, 0.15); color: var(--static-red-text); }

        .glass-btn-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); border: none; }
        
        #widgetBell { color: rgba(255, 255, 255, 0.3); transition: all 0.3s ease; }
        @keyframes bell-swing { 0%, 100% { transform: rotate(0); } 20% { transform: rotate(18deg); } 40% { transform: rotate(-18deg); } 60% { transform: rotate(10deg); } 80% { transform: rotate(-10deg); } }
        .swinging { animation: bell-swing 0.6s infinite ease-in-out !important; color: var(--static-green-text) !important; }

        .footer { display: flex; justify-content: center; margin-top: auto; padding-bottom: 30px; }
        .live-status-bar { display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.03); padding: 8px 18px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.05); }
        .pulse-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; position: relative; }
        @keyframes double-pulse { 0% { transform: scale(1); opacity: 1; } 70% { transform: scale(2.8); opacity: 0; } 100% { opacity: 0; } }
        .pulse-ring { position: absolute; width: 100%; height: 100%; background: #4ade80; border-radius: 50%; animation: double-pulse 2s infinite ease-out; opacity: 0; top:0; left:0; }
    </style>
</head>
<body>

    <div id="floatingAlert" onclick="dismissAlert()">
        <div id="faIconContainer"><span id="faIcon" class="material-symbols-outlined"></span></div>
        <div id="faContent">
            <div class="reveal-box"><div id="faTitle">...</div></div>
            <div class="reveal-box"><div id="faSubtitle">...</div></div>
        </div>
    </div>

    <div id="modalOverlay"><div id="modalContainer"></div></div>

    <div class="widget">
        <div class="header">
            <div class="crypto-icon"><img id="cryptoIconImg" src=""></div>
            <div><div id="cryptoName">BTC</div><div id="cryptoPair">BTC/USDT</div></div>
        </div>

        <div class="select-row">
            <select id="cryptoSelect" onchange="handleSelectChange()"></select>
            <button class="glass-btn-icon" style="color:var(--static-green-text);" onclick="openAddModal()"><span class="material-symbols-outlined">add</span></button>
            <button class="glass-btn-icon" style="color:var(--static-red-text);" onclick="confirmRemove()"><span class="material-symbols-outlined">delete</span></button>
        </div>

        <div class="tf-selector">
            <button id="tf1h" class="tf-btn" onclick="setTimeframe('1h')">1H</button>
            <button id="tf24h" class="tf-btn active" onclick="setTimeframe('24h')">24H</button>
        </div>

        <div class="price-display">
            <div class="price" id="price">$0.00</div>
            <div id="priceChangeContainer"><span id="priceChange">+0.00%</span></div>
        </div>

        <div class="stats">
            <div class="stat"><div>HIGH</div><div id="valHigh">--</div></div>
            <div class="stat"><div>LOW</div><div id="valLow">--</div></div>
            <div class="stat" style="grid-column: span 2;"><div id="volLabel">24H VOLUME</div><div id="valVol">--</div></div>
        </div>

        <div class="alarm-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="glass-btn-icon" style="width:40px; height:40px;"><span class="material-symbols-outlined" id="widgetBell">notifications</span></div>
                    <span style="font-weight:800;">ALERTS</span>
                </div>
                <button id="muteBtn" class="glass-btn-icon" onclick="toggleMute()" style="width:40px; height:40px;"><span class="material-symbols-outlined" id="muteIcon">volume_up</span></button>
            </div>
            <div class="alarm-grid">
                <input type="number" id="alarmHigh" placeholder="ABOVE" step="any">
                <input type="number" id="alarmLow" placeholder="BELOW" step="any">
                <button class="btn-static static-green" onclick="setAlarm()">SET</button>
                <button class="btn-static static-red" onclick="clearAlarm()">CLEAR</button>
            </div>
        </div>

        <div class="footer">
            <div class="live-status-bar">
                <div style="position:relative; width:8px; height:8px;"><div class="pulse-dot"></div><div class="pulse-ring"></div></div>
                <div id="liveClock">00:00:00</div>
            </div>
        </div>
    </div>

    <script>
        let ws, currentCrypto = 'btc', currentTimeframe = '24h', alarms = {}, timeframeData = {'1h':'0.00','24h':'0.00'}, isMuted = false, hourlyBasePrice = 0, lastAudioTime = 0, currentLiveVol = "--", hourlyVolume = "--", alertStates = {}; 
        let config = { 
            btc: { name: 'Bitcoin', symbol: 'BTC', pair: 'btcusdt', source: 'binance' },
            eth: { name: 'Ethereum', symbol: 'ETH', pair: 'ethusdt', source: 'binance' },
            reef: { name: 'Reef', symbol: 'REEF', pair: 'reef_usdt', source: 'gate' }
        };
        const audioUp = new Audio('https://raw.githubusercontent.com/teukka79/crypto-widget/main/price_up.mp3');

        function handleSelectChange() { currentCrypto = document.getElementById('cryptoSelect').value; changeCrypto(); save(); }
        function toggleMute() { isMuted = !isMuted; updateMuteUI(); save(); }
        function updateMuteUI() {
            const mb = document.getElementById('muteBtn'); const mi = document.getElementById('muteIcon');
            mb.style.color = isMuted ? 'var(--static-red-text)' : 'var(--static-green-text)';
            mi.innerText = isMuted ? 'volume_off' : 'volume_up';
        }

        // KUVAKEJÄRJESTYS: 1. Gate.io, 2. CoinGecko, 3. Binance (Proxy), 4. Fallback
        function changeCrypto() {
            const coin = config[currentCrypto];
            const sym = coin.symbol.toUpperCase();
            const iconImg = document.getElementById('cryptoIconImg');
            
            // 1. ENSISIJOINEN: Gate.io (toimii parhaiten mobiilissa ilman proxyja)
            let iconUrl = `https://www.gate.io/images/coin_icon/64/${sym.toLowerCase()}.png`;
            iconImg.src = iconUrl;

            iconImg.onerror = function() {
                // 2. TOINEN: CoinGecko
                console.log("Gate.io kuva ei löytynyt, kokeillaan CoinGeckoa...");
                this.src = `https://assets.coingecko.com/coins/images/279/large/${sym.toLowerCase()}.png`;
                
                this.onerror = function() {
                    // 3. KOLMAS: Binance (Proxyn kautta)
                    console.log("CoinGecko ei löytynyt, kokeillaan Binance Proxy...");
                    this.src = `https://corsproxy.io/?https://bin.bnbstatic.com/static/assets/logos/${sym}.png`;
                    
                    this.onerror = function() {
                        // 4. NELJÄS: UI-Avatar (Kirjainkuvake)
                        this.src = `https://ui-avatars.com/api/?name=${sym}&background=000033&color=4ade80&bold=true`;
                        this.onerror = null;
                    };
                };
            };

            document.getElementById('cryptoName').innerText = coin.symbol;
            document.getElementById('cryptoPair').innerText = coin.symbol + '/USDT';
            document.getElementById('alarmHigh').value = (alarms[currentCrypto] || {}).high || '';
            document.getElementById('alarmLow').value = (alarms[currentCrypto] || {}).low || '';
            connect(); fetch1hData(currentCrypto); dismissAlert(); 
        }

        function connect() {
            if (ws) ws.close();
            const coin = config[currentCrypto];
            const url = (coin.source === 'gate' || coin.symbol === "REEF") ? "wss://api.gateio.ws/ws/v4/" : `wss://stream.binance.com:9443/ws/${coin.pair}@ticker`;
            ws = new WebSocket(url);
            if (coin.source === 'gate' || coin.symbol === "REEF") {
                ws.onopen = () => ws.send(JSON.stringify({channel:"spot.tickers", event:"subscribe", payload:[coin.symbol+"_USDT"]}));
                ws.onmessage = (e) => { const r = JSON.parse(e.data); if (r.event === "update") handleTickerData(r.result.last, r.result.change_percentage, r.result.high_24h, r.result.low_24h, r.result.quote_volume); };
            } else {
                ws.onmessage = (e) => { const d = JSON.parse(e.data); handleTickerData(d.c, d.P, d.h, d.l, d.q); };
            }
        }

        function handleTickerData(price, change, high, low, vol) {
            const p = parseFloat(price); const decimals = (config[currentCrypto].symbol === "REEF") ? 8 : (p < 10 ? 4 : 2);
            document.getElementById('price').innerText = '$' + p.toLocaleString(undefined, {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
            timeframeData['24h'] = change;
            if (hourlyBasePrice > 0) timeframeData['1h'] = (((p - hourlyBasePrice) / hourlyBasePrice) * 100).toFixed(2);
            updateChangeDisplay();
            document.getElementById('valHigh').innerText = '$' + parseFloat(high).toLocaleString(undefined, {maximumFractionDigits: decimals});
            document.getElementById('valLow').innerText = '$' + parseFloat(low).toLocaleString(undefined, {maximumFractionDigits: decimals});
            currentLiveVol = '$' + parseFloat(vol).toLocaleString(undefined, {maximumFractionDigits: 0});
            updateVolDisplay(); checkAlarms(p);
        }

        function checkAlarms(p) {
            const a = alarms[currentCrypto]; if (!a) return;
            const now = Date.now(); const cKey = currentCrypto;
            if (!alertStates[cKey]) alertStates[cKey] = { h: false, l: false };
            let hit = false; let direction = '';
            const decimals = (config[cKey].symbol === "REEF") ? 8 : (p < 10 ? 4 : 2);
            const fmtPrice = '$' + p.toLocaleString(undefined, {minimumFractionDigits: decimals, maximumFractionDigits: decimals});
            if (a.high && p >= a.high) { if (!alertStates[cKey].h) { hit = true; alertStates[cKey].h = true; direction = 'up'; } } else { alertStates[cKey].h = false; }
            if (a.low && p <= a.low) { if (!alertStates[cKey].l) { hit = true; alertStates[cKey].l = true; direction = 'down'; } } else { alertStates[cKey].l = false; }
            if (hit) { if (!isMuted && (now - lastAudioTime > 30000)) { audioUp.play().catch(e => {}); lastAudioTime = now; } showFloatingAlert(config[cKey].symbol, direction, fmtPrice, (direction === 'up' ? a.high : a.low), false); }
        }

        function showFloatingAlert(symbol, dir, price, target, isConfirmation = false) {
            const fa = document.getElementById('floatingAlert'); const faIcon = document.getElementById('faIcon'); const faTitle = document.getElementById('faTitle'); const faSubtitle = document.getElementById('faSubtitle'); const wb = document.getElementById('widgetBell');
            fa.classList.remove('show');
            setTimeout(() => {
                if (isConfirmation) { fa.style.background = 'rgba(255, 255, 255, 0.12)'; faIcon.innerText = 'task_alt'; faIcon.style.color = '#4ade80'; faTitle.innerText = 'SETTING SAVED'; faSubtitle.innerText = `${symbol} alerts updated.`; } 
                else { const isUp = dir === 'up'; fa.style.background = isUp ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'; faIcon.innerText = isUp ? 'trending_up' : 'trending_down'; faIcon.style.color = isUp ? '#4ade80' : '#ff5252'; faTitle.innerText = `${symbol} TARGET HIT!`; faSubtitle.innerText = `Reached $${target}`; wb.innerText = 'notifications_active'; wb.classList.add('swinging'); }
                fa.classList.add('show');
            }, 100);
            setTimeout(() => { if (fa.classList.contains('show')) dismissAlert(); }, 8000);
        }

        function dismissAlert() { document.getElementById('floatingAlert').classList.remove('show'); const wb = document.getElementById('widgetBell'); wb.classList.remove('swinging'); wb.innerText = 'notifications'; wb.style.color = 'rgba(255, 255, 255, 0.3)'; }
        function setAlarm() { const sym = config[currentCrypto].symbol; alarms[currentCrypto] = { high: document.getElementById('alarmHigh').value, low: document.getElementById('alarmLow').value }; alertStates[currentCrypto] = { h: false, l: false }; save(); showFloatingAlert(sym, 'up', null, null, true); }
        function clearAlarm() { document.getElementById('alarmHigh').value = ''; document.getElementById('alarmLow').value = ''; delete alarms[currentCrypto]; dismissAlert(); save(); }

        async function fetch1hData(cKey) {
            const coin = config[cKey];
            try {
                const url = (coin.source === 'binance' && coin.symbol !== "REEF") ? `https://api.binance.com/api/v3/klines?symbol=${coin.pair.toUpperCase()}&interval=1h&limit=1` : `https://api.gateio.ws/api/v4/spot/candlesticks?currency_pair=${coin.symbol}_USDT&interval=1h&limit=1`;
                const res = await fetch(url); const d = await res.json();
                hourlyBasePrice = (coin.source === 'binance') ? parseFloat(d[0][1]) : parseFloat(d[0][5]);
                hourlyVolume = '$' + ((coin.source === 'binance') ? (parseFloat(d[0][5]) * hourlyBasePrice) : parseFloat(d[0][1])).toLocaleString(undefined, {maximumFractionDigits: 0});
                updateVolDisplay();
            } catch(e) {}
        }

        function updateChangeDisplay() {
            const val = parseFloat(timeframeData[currentTimeframe]); const cont = document.getElementById('priceChangeContainer');
            cont.style.color = val >= 0 ? 'var(--static-green-text)' : 'var(--static-red-text)';
            cont.style.backgroundColor = val >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
            document.getElementById('priceChange').innerText = (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
        }

        function updateVolDisplay() {
            document.getElementById('volLabel').innerText = currentTimeframe === '1h' ? "1H VOLUME" : "24H VOLUME";
            document.getElementById('valVol').innerText = currentTimeframe === '1h' ? hourlyVolume : currentLiveVol;
        }

        function setTimeframe(tf) { currentTimeframe = tf; document.getElementById('tf1h').classList.toggle('active', tf==='1h'); document.getElementById('tf24h').classList.toggle('active', tf==='24h'); updateChangeDisplay(); updateVolDisplay(); }
        
        function save() { 
            localStorage.setItem('crypto_glass_v55', JSON.stringify({ config, current: currentCrypto, alarms, isMuted }));
            localStorage.setItem('portfolioStatus', JSON.stringify({ lastUpdate: Date.now() })); 
        }

        function openAddModal() {
            document.getElementById('modalOverlay').style.display = 'flex';
            document.getElementById('modalContainer').innerHTML = `<h3 style="margin-top:0;">ADD TOKEN</h3><input type="text" id="modalInput" style="width:100%; height:54px; background:rgba(255,255,255,0.05); color:#fff; text-align:center; border:1px solid var(--glass-border); border-radius:14px; margin-bottom:20px; font-size:18px; font-weight:800;" placeholder="SYMBOL"><div style="display:flex; gap:10px;"><button class="btn-static static-green" style="flex:1;" onclick="confirmAdd('binance')">BINANCE</button><button class="btn-static static-green" style="flex:1;" onclick="confirmAdd('gate')">GATE.IO</button></div><button class="btn-static" style="background:#333; color:white; width:100%; margin-top:10px;" onclick="closeModal()">CLOSE</button>`;
            setTimeout(() => document.getElementById('modalInput').focus(), 100);
        }

        function confirmAdd(src) { const sym = document.getElementById('modalInput').value.toUpperCase().trim(); if(!sym) return; config[sym.toLowerCase()] = { name: sym, symbol: sym, pair: (src==='binance' ? sym.toLowerCase()+'usdt' : sym.toLowerCase()+'_usdt'), source: src }; currentCrypto = sym.toLowerCase(); updateSelectMenu(); closeModal(); changeCrypto(); save(); }
        function updateSelectMenu() { const sel = document.getElementById('cryptoSelect'); sel.innerHTML = ''; Object.keys(config).sort().forEach(k => { const o = document.createElement('option'); o.value = k; o.text = `${config[k].symbol} (${config[k].source === 'binance' ? 'Binance' : 'Gate.io'})`; if(k === currentCrypto) o.selected = true; sel.add(o); }); }
        function confirmRemove() { const name = config[currentCrypto].symbol; document.getElementById('modalOverlay').style.display = 'flex'; document.getElementById('modalContainer').innerHTML = `<h3>REMOVE ${name}?</h3><div style=\"display:flex; gap:10px; margin-top:20px;\"><button class=\"btn-static static-red\" style=\"flex:1;\" onclick=\"executeRemove()\">DELETE</button><button class=\"btn-static\" style=\"background:#333; color:white; flex:1;\" onclick=\"closeModal()\">CANCEL</button></div>`; }
        function executeRemove() { delete config[currentCrypto]; const rem = Object.keys(config); currentCrypto = rem.length > 0 ? rem[0] : 'btc'; save(); location.reload(); }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('fi-FI', { hour12: false }); }, 1000);
        window.onload = () => { const saved = JSON.parse(localStorage.getItem('crypto_glass_v55')); if (saved) { config = saved.config || config; currentCrypto = saved.current || 'btc'; alarms = saved.alarms || {}; isMuted = saved.isMuted || false; } updateSelectMenu(); changeCrypto(); updateMuteUI(); };
    </script>
</body>
</html>
